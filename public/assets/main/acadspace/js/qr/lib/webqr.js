var gCtx=null,gCanvas=null,c=0,stype=0,gUM=!1,webkit=!1,moz=!1,v=null,canvasblade="",videoblade="",canvasgblade="",cadenaControl="",dimensions={height:0,width:0,start:0,end:0},elements={video:null,canvas:null,ctx:null,canvasg:null,ctxg:null},config={strokeColor:"#0cf404",start:.1,end:.9,threshold:160,quality:.45,delay:100},imghtml='<div id="qrfile"><canvas id="out-canvas" width="320" height="240"></canvas><div id="imghelp">drag and drop a QRCode here<br>or select a file<input type="file" onchange="handleFiles(this.files)"/></div></div>',vidhtml='<video id="v" autoplay></video><canvas id="barcodecanvasg"></canvas>';function dragenter(e){e.stopPropagation(),e.preventDefault()}function dragover(e){e.stopPropagation(),e.preventDefault()}function drop(e){e.stopPropagation(),e.preventDefault();var t=e.dataTransfer,n=t.files;n.length>0?handleFiles(n):t.getData("URL")&&qrcode.decode(t.getData("URL"))}function handleFiles(e){for(var t=0;t<e.length;t++){var n=new FileReader;n.onload=(e[t],function(e){gCtx.clearRect(0,0,gCanvas.width,gCanvas.height),qrcode.decode(e.target.result)}),n.readAsDataURL(e[t])}}function initCanvas(e,t){(gCanvas=document.getElementById("qr-canvas")).style.width=e+"px",gCanvas.style.height=t+"px",gCanvas.width=e,gCanvas.height=t,(gCtx=gCanvas.getContext("2d")).clearRect(0,0,e,t)}function captureToCanvas(){if(1==stype&&gUM)try{gCtx.drawImage(v,0,0);try{qrcode.decode()}catch(e){setTimeout(captureToCanvas,20)}}catch(e){setTimeout(captureToCanvas,20)}}function htmlEntities(e){return String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")}function read(e){var t,n=null,o=0,a=[];a[3]=!0,a[4]=!1,a[1]=!0,a[5]=!1;var s=/^([0-9])*$/;for(i=0;i<e.length;i++)"|"==e.charAt(i)&&(o++,console.log(o+" "+e));if(4==o){console.log("RETIRANDO | DE : "+e),t=e.split("|"),a[5]=!0,(t[1].length<1||t[2].length<1||t[3].length<1)&&(console.log("ARRAY  error : "+t[0]+t[1]+t[2]+t[3]),t[1]="0",t[2]="0",t[3]="0",a[5]=!1),s.test(t[0])&&s.test(t[1])&&s.test(t[2])&&s.test(t[3])?(document.getElementById("codigo").value=t[0],a[5]=!0):(t[0]="0",t[1]="0",t[2]="0",t[3]="0",a[5]=!1);var l=document.getElementById("SOL_carrera"),r=document.getElementById("SOL_laboratorios"),c=document.getElementById("aula");console.log(cadenaControl+"==="+t)}else a[5]=!1;if(cadenaControl.toString()===t.toString())document.getElementById("codigo").value="",UIToastr.init("warning","Retirar QR","¡Se acaba de proporcionar el QR!"),setTimeout(captureToCanvas,1e3);else if(UIToastr.init("info","Registrando...","Validando QR"),a[5])try{null==t[4]?a[4]=!1:n=t[4],console.log("HASH DE QR : "+n);var d=new Date(Date.now()).toISOString().slice(0,-1);d=d.replace("T"," "),$.get("verificarHash/"+t[0]+"/"+n+"/"+d,function(e){$(e.data).each(function(e,n){console.log("-----------------------\x3e"+n),a[4]=n;for(var o=0;i=l.options[o];o++)if(console.log("ENTRA A SELECTOR DE CARRERA "+i.value),i.value==t[1]){console.log("Valor selector Carrera :"+i.value+" Valor del QR :"+t[1]),l.selectedIndex=o,a[0]=!0;break}var i;for(o=0;i=r.options[o];o++)if(console.log("ENTRA A SELECTOR DE ESPACIO "),i.value==t[2]){console.log("Valor selector Espacio :"+i.value+" Valor del QR :"+t[2]),r.selectedIndex=o,console.log(a[3]),a[3]&&(console.log("If del ciclo de llenado"),$("#aula").empty(),$("#aula").append(new Option("Sala general",2)),a[2]=!0,cadenaControl=t,$("#aula").val([]));break}validate(a[0],a[1],a[2],a[4],c,t[3]),a[3]=!1,a[1]=!0})})}catch(e){console.log("ERROR : "+e)}else validate(!1,!1,!1,!1,c,t[3]),a[3]=!1,a[1]=!0}function validate(e,t,n,o,a,i){for(var s,l=0;s=a.options[l];l++)if(s.value==i){console.log("Valor selector Sala :"+s.value+" Valor del QR :"+i),a.selectedIndex=l;break}console.log(e),console.log(t),console.log(n),console.log(o),e&&t&&n&&o?(console.log("LOS VALORES SON _______________________________"),console.log($('select[name="SOL_carrera"]').val()),console.log($('select[name="SOL_laboratorios"]').val()),console.log($('select[name="aula"]').val()),console.log("LOS VALORES SON _______________________________"),$(".create").click(),setTimeout(captureToCanvas,1e3)):(UIToastr.init("error","QR Obsoleto o Corrupto","¡Por favor genere otro QR!"),document.getElementById("SOL_carrera").disabled=!1,document.getElementById("SOL_laboratorios").disabled=!1,document.getElementById("aula").disabled=!1,setTimeout(captureToCanvas,1e3))}function isCanvasSupported(){var e=document.createElement("canvas");return!(!e.getContext||!e.getContext("2d"))}function success(e){v.srcObject=e,v.play(),gUM=!0,setTimeout(captureToCanvas,20)}function error(e){gUM=!1}function load(){console.log("COMO LOCO PERRO"),isCanvasSupported()&&window.File&&window.FileReader?(initCanvas(800,600),qrcode.callback=read,document.getElementById("mainbody").style.display="inline",setwebcam()):(document.getElementById("mainbody").style.display="inline",document.getElementById("mainbody").innerHTML='<p id="mp1">QR code scanner for HTML5 capable browsers</p><br><br><p id="mp2">sorry your browser is not supported</p><br><br><p id="mp1">try <a href="http://www.mozilla.com/firefox"><img src="firefox.png"/></a> or <a href="http://chrome.google.com"><img src="chrome_logo.gif"/></a> or <a href="http://www.opera.com"><img src="Opera-logo.png"/></a></p>')}function setwebcam(){var e=!0;if(navigator.mediaDevices&&navigator.mediaDevices.enumerateDevices)try{navigator.mediaDevices.enumerateDevices().then(function(t){t.forEach(function(t){"videoinput"===t.kind&&t.label.toLowerCase().search("back")>-1&&(e={deviceId:{exact:t.deviceId},facingMode:"environment"}),console.log(t.kind+": "+t.label+" id = "+t.deviceId)}),setwebcam2(e)})}catch(e){console.log(e)}else console.log("no navigator.mediaDevices.enumerateDevices"),setwebcam2(e)}function setwebcam2(e){if(console.log(e),1!=stype){var t=navigator;document.getElementById("outdiv").innerHTML=vidhtml,v=document.getElementById("v"),t.mediaDevices.getUserMedia?t.mediaDevices.getUserMedia({video:e,audio:!1}).then(function(e){success(e)}).catch(function(e){e(e)}):t.getUserMedia?(webkit=!0,t.getUserMedia({video:e,audio:!1},success,error)):t.webkitGetUserMedia&&(webkit=!0,t.webkitGetUserMedia({video:e,audio:!1},success,error)),elements.video=document.querySelector(videoblade),elements.canvas=document.querySelector(canvasblade),elements.ctx=elements.canvas.getContext("2d"),elements.canvasg=document.querySelector(canvasgblade),elements.ctxg=elements.canvasg.getContext("2d"),elements.video.addEventListener("canplay",function(e){console.log("ENTROOO AL PINTAR"),dimensions.height=elements.video.videoHeight,console.log("HEIGHT : "+dimensions.height),dimensions.width=elements.video.videoWidth,console.log("WIDTH : "+dimensions.width),dimensions.start=dimensions.width*config.start,dimensions.end=dimensions.width*config.end,elements.canvas.width=dimensions.width,elements.canvas.height=dimensions.height,elements.canvasg.width=dimensions.width,elements.canvasg.height=dimensions.height,drawGraphics(),drawGraphics2(),drawGraphics3(),drawGraphics4()},!1),stype=1,setTimeout(captureToCanvas,20)}else setTimeout(captureToCanvas,20)}function setimg(){if(document.getElementById("result").innerHTML="",2!=stype){document.getElementById("outdiv").innerHTML=imghtml,document.getElementById("qrimg").style.opacity=1,document.getElementById("webcamimg").style.opacity=.2;var e=document.getElementById("qrfile");e.addEventListener("dragenter",dragenter,!1),e.addEventListener("dragover",dragover,!1),e.addEventListener("drop",drop,!1),stype=2}}function drawGraphics(){elements.ctxg.strokeStyle=config.strokeColor,elements.ctxg.lineWidth=6,elements.ctxg.beginPath(),elements.ctxg.moveTo(dimensions.start+34,60),elements.ctxg.lineTo(dimensions.end-28,60),elements.ctxg.stroke()}function drawGraphics2(){elements.ctxg.strokeStyle=config.strokeColor,elements.ctxg.lineWidth=6,elements.ctxg.beginPath(),elements.ctxg.moveTo(dimensions.start+34,420),elements.ctxg.lineTo(100,60),elements.ctxg.stroke()}function drawGraphics3(){elements.ctxg.strokeStyle=config.strokeColor,elements.ctxg.lineWidth=6,elements.ctxg.beginPath(),elements.ctxg.moveTo(dimensions.end-30,420),elements.ctxg.lineTo(dimensions.end-30,60),elements.ctxg.stroke()}function drawGraphics4(){elements.ctxg.strokeStyle=config.strokeColor,elements.ctxg.lineWidth=6,elements.ctxg.beginPath(),elements.ctxg.moveTo(dimensions.end-30,420),elements.ctxg.lineTo(dimensions.start+34,420),elements.ctxg.stroke()}